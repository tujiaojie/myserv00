#!/bin/bash

# --- 基础配置 ---
USER_NAME="tujiaojie"
REPO_NAME="my-serv00"
WORKDIR="$HOME/mynode"
SB_BIN="$WORKDIR/sing-box"
CONFIG="$WORKDIR/config.json"
RAW_URL="https://raw.githubusercontent.com/$USER_NAME/$REPO_NAME/main"

# 颜色定义
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- 自动化安装核心 ---
install_core() {
    if [ ! -f "$SB_BIN" ]; then
        echo -e "${YELLOW}正在通过加速镜像下载 sing-box 核心...${NC}"
        mkdir -p $WORKDIR && cd $WORKDIR
        # 使用 ghproxy 加速，确保 Serv00 下载不报错
        wget https://ghproxy.net/https://github.com/SagerNet/sing-box/releases/download/v1.8.5/sing-box-1.8.5-freebsd-amd64.tar.gz
        tar -zxvf sing-box-1.8.5-freebsd-amd64.tar.gz
        mv sing-box-1.8.5-freebsd-amd64/sing-box .
        chmod +x sing-box
        rm -rf sing-box-1.8.5-freebsd-amd64*
    fi
}

# --- 自动化拉取配置 ---
sync_config() {
    echo -e "${YELLOW}正在同步 GitHub 仓库中的配置文件...${NC}"
    mkdir -p $WORKDIR
    wget -O $CONFIG "$RAW_URL/config.json"
    if [ $? -ne 0 ]; then
        echo -e "${RED}同步失败，请检查仓库名或用户名是否正确！${NC}"
    else
        echo -e "${GREEN}配置同步成功！${NC}"
    fi
}

# --- 菜单逻辑 ---
show_menu() {
    clear
    echo -e "${GREEN}=== 我的 Serv00 快捷管理 (像勇哥一样) ===${NC}"
    echo -e "1. ${GREEN}安装/重启 节点${NC} (自动同步配置)"
    echo -e "2. ${YELLOW}查看 分享链接${NC}"
    echo -e "3. ${RED}卸载 代理服务${NC}"
    echo -e "0. 退出"
    read -p "请输入选项: " choice

    case $choice in
        1) install_core; sync_config; pkill -9 sing-box; cd $WORKDIR; nohup ./sing-box run -c config.json > /dev/null 2>&1 & echo -e "${GREEN}✅ 节点已启动！${NC}";;
        2) 
            PORT=$(grep 'listen_port' $CONFIG | tr -cd '0-9')
            UUID=$(grep 'uuid' $CONFIG | awk -F'"' '{print $4}')
            IP=$(curl -s ipv4.icanhazip.com)
            PATH_WS=$(grep 'path' $CONFIG | awk -F'"' '{print $4}')
            echo -e "${GREEN}vless://$UUID@$IP:$PORT?encryption=none&security=none&type=ws&path=$PATH_WS#Serv00_Node${NC}"
            read -p "按任意键返回..." ;;
        3) pkill -9 sing-box; rm -rf $WORKDIR; echo -e "${RED}已卸载。${NC}"; exit 0;;
        *) exit 0;;
    esac
}

show_menu
