#!/bin/bash

# --- åŸºç¡€é…ç½® ---
USER_NAME="tujiaojie"
REPO_NAME="myserv00"
WORKDIR="$HOME/mynode"
SB_BIN="$WORKDIR/sing-box"
CONFIG="$WORKDIR/config.json"
RAW_URL="https://raw.githubusercontent.com/$USER_NAME/$REPO_NAME/main"

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- æ ¸å¿ƒç¨‹åºä¸‹è½½ ---
install_core() {
    if [ ! -f "$SB_BIN" ]; then
        echo -e "${YELLOW}æ­£åœ¨é€šè¿‡åŠ é€Ÿé•œåƒä¸‹è½½ sing-box æ ¸å¿ƒ...${NC}"
        mkdir -p $WORKDIR && cd $WORKDIR
        wget https://ghproxy.net/https://github.com/SagerNet/sing-box/releases/download/v1.8.5/sing-box-1.8.5-freebsd-amd64.tar.gz
        tar -zxvf sing-box-1.8.5-freebsd-amd64.tar.gz
        mv sing-box-1.8.5-freebsd-amd64/sing-box .
        chmod +x sing-box
        rm -rf sing-box-1.8.5-freebsd-amd64*
    fi
}

# --- åŒæ­¥é…ç½® ---
sync_config() {
    echo -e "${YELLOW}æ­£åœ¨ä»Ž GitHub åŒæ­¥æœ€æ–°é…ç½®...${NC}"
    mkdir -p $WORKDIR
    # ä½¿ç”¨ -q ä¿æŒå®‰é™ï¼Œ-O å¼ºåˆ¶è¦†ç›–æœ¬åœ°
    wget -q -O $CONFIG "$RAW_URL/config.json"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… é…ç½®åŒæ­¥æˆåŠŸï¼${NC}"
    else
        echo -e "${RED}âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“åå’Œ Public çŠ¶æ€ï¼${NC}"
    fi
}

# --- èœå•é€»è¾‘ ---
show_menu() {
    clear
    echo -e "${GREEN}======================================${NC}"
    echo -e "${YELLOW}    tujiaojie ä¸“å±ž Serv00 ç®¡ç†èœå•    ${NC}"
    echo -e "${GREEN}======================================${NC}"
    echo -e "  1. å¯åŠ¨/é‡å¯ èŠ‚ç‚¹ (å«åŒæ­¥é…ç½®)"
    echo -e "  2. æŸ¥çœ‹ VLESS åˆ†äº«é“¾æŽ¥"
    echo -e "  3. åœæ­¢ ä»£ç†æœåŠ¡"
    echo -e "  4. å½»åº•å¸è½½ (åˆ é™¤æ‰€æœ‰æ–‡ä»¶)"
    echo -e "  0. é€€å‡ºè„šæœ¬"
    echo -e "${GREEN}======================================${NC}"
    read -p "è¯·è¾“å…¥é€‰é¡¹: " choice

    case $choice in
        1)
            install_core
            sync_config
            pkill -9 sing-box
            cd $WORKDIR
            nohup ./sing-box run -c config.json > /dev/null 2>&1 & 
            echo -e "${GREEN}ðŸš€
