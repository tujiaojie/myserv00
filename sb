#!/bin/bash

USER_NAME="tujiaojie"
REPO_NAME="myserv00"
WORKDIR="$HOME/mynode"
SB_BIN="$WORKDIR/sing-box"
CONFIG="$WORKDIR/config.json"
RAW_URL="https://raw.githubusercontent.com/$USER_NAME/$REPO_NAME/main"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

install_core() {
    if [ ! -f "$SB_BIN" ]; then
        echo -e "${YELLOW}æ­£åœ¨ä¸‹è½½æ ¸å¿ƒç¨‹åº...${NC}"
        mkdir -p $WORKDIR && cd $WORKDIR
        wget https://ghproxy.net/https://github.com/SagerNet/sing-box/releases/download/v1.8.5/sing-box-1.8.5-freebsd-amd64.tar.gz
        tar -zxvf sing-box-1.8.5-freebsd-amd64.tar.gz
        mv sing-box-1.8.5-freebsd-amd64/sing-box .
        chmod +x sing-box
        rm -rf sing-box-1.8.5-freebsd-amd64*
    fi
}

sync_config() {
    echo -e "${YELLOW}æ­£åœ¨åŒæ­¥é…ç½®...${NC}"
    mkdir -p $WORKDIR
    wget -q -O $CONFIG "$RAW_URL/config.json"
    [ $? -eq 0 ] && echo -e "${GREEN}âœ… åŒæ­¥æˆåŠŸ${NC}" || echo -e "${RED}âŒ åŒæ­¥å¤±è´¥${NC}"
}

show_menu() {
    clear
    echo -e "${GREEN}======================================${NC}"
    echo -e "${YELLOW}    tujiaojie ä¸“å± Serv00 ç®¡ç†å™¨    ${NC}"
    echo -e "${GREEN}======================================${NC}"
    echo -e "  1. å¯åŠ¨/é‡å¯ èŠ‚ç‚¹"
    echo -e "  2. æŸ¥çœ‹ åˆ†äº«é“¾æ¥"
    echo -e "  3. åœæ­¢ ä»£ç†"
    echo -e "  0. é€€å‡º"
    echo -e "${GREEN}======================================${NC}"
    read -p "é€‰æ‹©: " choice

    case $choice in
        1)
            install_core
            sync_config
            pkill -9 sing-box
            cd $WORKDIR && nohup ./sing-box run -c config.json > /dev/null 2>&1 & 
            echo -e "${GREEN}ğŸš€ å·²å¯åŠ¨ï¼${NC}"
            sleep 2; show_menu
            ;;
        2)
            if [ -f "$CONFIG" ]; then
                PORT=$(grep '"listen_port":' $CONFIG | tr -cd '0-9')
                UUID=$(grep '"uuid":' $CONFIG | awk -F'"' '{print $4}')
                PATH_WS=$(grep '"path":' $CONFIG | awk -F'"' '{print $4}')
                IP=$(curl -s ipv4.icanhazip.com)
                echo -e "\n${YELLOW}åˆ†äº«é“¾æ¥:${NC}"
                echo -e "${GREEN}vless://$UUID@$IP:$PORT?encryption=none&security=none&type=ws&path=${PATH_WS}#Serv00_tujiaojie${NC}\n"
            else
                echo -e "${RED}è¯·å…ˆé€‰ 1${NC}"
            fi
            read -p "æŒ‰å›è½¦è¿”å›..." ; show_menu
            ;;
        3)
            pkill -9 sing-box && echo -e "${RED}å·²åœæ­¢${NC}"
            sleep 2; show_menu
            ;;
        0)
            exit 0
            ;;
        *)
            show_menu
            ;;
    esac
}

show_menu
