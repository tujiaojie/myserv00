#!/bin/bash

# --- åŸºç¡€é…ç½® ---
USER_NAME="tujiaojie"
REPO_NAME="myserv00"
WORKDIR="$HOME/mynode"
SB_BIN="$WORKDIR/sing-box"
CONFIG="$WORKDIR/config.json"
RAW_URL="https://raw.githubusercontent.com/$USER_NAME/$REPO_NAME/main"

# é¢œè‰²
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# å®‰è£…æ ¸å¿ƒ (å‹‡å“¥åŒæ¬¾ FreeBSD æ¶æ„)
install_core() {
    if [ ! -f "$SB_BIN" ]; then
        echo -e "${YELLOW}æ­£åœ¨è·å– sing-box æ ¸å¿ƒ...${NC}"
        mkdir -p $WORKDIR && cd $WORKDIR
        # ä½¿ç”¨å‹‡å“¥å¸¸ç”¨çš„ ghproxy é•œåƒä»¥ä¿æˆåŠŸ
        wget https://mirror.ghproxy.com/https://github.com/SagerNet/sing-box/releases/download/v1.10.1/sing-box-1.10.1-freebsd-amd64.tar.gz
        tar -zxvf sing-box-1.10.1-freebsd-amd64.tar.gz
        cp sing-box-*/sing-box . && chmod +x sing-box
        rm -rf sing-box-1.10.1-freebsd-amd64*
    fi
}

# ç®¡ç†èœå•
show_menu() {
    clear
    echo -e "${GREEN}======================================${NC}"
    echo -e "${YELLOW}    å‹‡å“¥é£æ ¼ï¼šServ00 èŠ‚ç‚¹ç®¡ç†å™¨       ${NC}"
    echo -e "${GREEN}======================================${NC}"
    echo -e "  1. å¯åŠ¨/é‡å¯ èŠ‚ç‚¹ (åŒæ­¥ GitHub é…ç½®)"
    echo -e "  2. æå– VLESS åˆ†äº«é“¾æ¥"
    echo -e "  3. åœæ­¢ èŠ‚ç‚¹"
    echo -e "  0. é€€å‡º"
    echo -e "${GREEN}======================================${NC}"
    read -p "é€‰æ‹©: " choice

    case $choice in
        1)
            install_core
            wget -q -O $CONFIG "$RAW_URL/config.json"
            pkill -9 sing-box
            cd $WORKDIR && nohup ./sing-box run -c config.json > /dev/null 2>&1 & 
            echo -e "${GREEN}ğŸš€ èŠ‚ç‚¹å·²åœ¨åå°æ‰“ç«ï¼${NC}"
            sleep 2; show_menu ;;
        2)
            if [ -f "$CONFIG" ]; then
                # --- å‹‡å“¥å¼ç²¾å‡†æå–ï¼šåˆ©ç”¨ python æˆ– grep å¼ºè¡Œå®šä½ ---
                PORT=$(grep -oE '"listen_port": [0-9]+' $CONFIG | awk '{print $2}')
                UUID=$(grep -oE '"id": "[^"]+"' $CONFIG | head -1 | awk -F'"' '{print $4}')
                PATH_WS=$(grep -oE '"path": "[^"]+"' $CONFIG | awk -F'"' '{print $4}')
                IP=$(curl -s ipv4.icanhazip.com)
                echo -e "\n${YELLOW}æ‚¨çš„èŠ‚ç‚¹ä¿¡æ¯:${NC}"
                echo -e "${GREEN}vless://$UUID@$IP:$PORT?encryption=none&security=none&type=ws&path=$PATH_WS#Serv00_Tujiaojie${NC}\n"
            else
                echo -e "${RED}è¯·å…ˆæ‰§è¡Œ 1 å¯åŠ¨èŠ‚ç‚¹${NC}"
            fi
            read -p "å›è½¦è¿”å›..." ; show_menu ;;
        3) pkill -9 sing-box; echo -e "${RED}å·²åœæ­¢${NC}"; sleep 1; show_menu ;;
        0) exit 0 ;;
        *) show_menu ;;
    esac
}

show_menu
