#!/bin/bash

# --- åŸºç¡€é…ç½® (å·²ä¸ºæ‚¨ç²¾å‡†æ ¡å¯¹) ---
USER_NAME="tujiaojie"
REPO_NAME="myserv00"
WORKDIR="$HOME/mynode"
SB_BIN="$WORKDIR/sing-box"
CONFIG="$WORKDIR/config.json"
RAW_URL="https://raw.githubusercontent.com/$USER_NAME/$REPO_NAME/main"

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- æ ¸å¿ƒç¨‹åºä¸‹è½½ ---
install_core() {
    if [ ! -f "$SB_BIN" ]; then
        echo -e "${YELLOW}æ­£åœ¨ä¸‹è½½æ ¸å¿ƒç¨‹åº...${NC}"
        mkdir -p $WORKDIR && cd $WORKDIR
        # ä½¿ç”¨ ghproxy åŠ é€Ÿé“¾æ¥ï¼Œç¡®ä¿ 100% ä¸‹è½½æˆåŠŸ
        wget https://ghproxy.net/https://github.com/SagerNet/sing-box/releases/download/v1.8.5/sing-box-1.8.5-freebsd-amd64.tar.gz
        tar -zxvf sing-box-1.8.5-freebsd-amd64.tar.gz
        mv sing-box-1.8.5-freebsd-amd64/sing-box .
        chmod +x sing-box
        rm -rf sing-box-1.8.5-freebsd-amd64*
    fi
}

# --- åŒæ­¥é…ç½® (æ ¸å¿ƒä¿®æ­£ç‚¹) ---
sync_config() {
    echo -e "${YELLOW}æ­£åœ¨åŒæ­¥ GitHub é…ç½®: $RAW_URL/config.json ...${NC}"
    mkdir -p $WORKDIR
    # åŠ ä¸Š -q -O ç¡®ä¿ä¸‹è½½å¹¶è¦†ç›–
    wget -q -O $CONFIG "$RAW_URL/config.json"
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥ GitHub ä»“åº“åæ˜¯å¦ä¸º myserv00${NC}"
    else
        echo -e "${GREEN}âœ… é…ç½®å·²æˆåŠŸä» GitHub åŒæ­¥ï¼${NC}"
    fi
}

# --- èœå•ç•Œé¢ ---
show_menu() {
    clear
    echo -e "${GREEN}======================================${NC}"
    echo -e "${YELLOW}    tujiaojie ä¸“å± Serv00 èŠ‚ç‚¹ç®¡ç†    ${NC}"
    echo -e "${GREEN}======================================${NC}"
    echo -e "  1. å¯åŠ¨/é‡å¯ èŠ‚ç‚¹ (è‡ªåŠ¨åŒæ­¥é…ç½®)"
    echo -e "  2. æŸ¥çœ‹ èŠ‚ç‚¹åˆ†äº«é“¾æ¥"
    echo -e "  3. åœæ­¢ ä»£ç†æœåŠ¡"
    echo -e "  4. å¸è½½ ä»£ç†æœåŠ¡"
    echo -e "  0. é€€å‡ºè„šæœ¬"
    echo -e "${GREEN}======================================${NC}"
    read -p "è¯·è¾“å…¥é€‰é¡¹: " choice

    case $choice in
        1) 
            install_core
            sync_config
            pkill -9 sing-box
            cd $WORKDIR
            nohup ./sing-box run -c config.json > /dev/null 2>&1 & 
            echo -e "${GREEN}ğŸš€ èŠ‚ç‚¹å·²åœ¨åå°å¯åŠ¨ï¼${NC}"
            sleep 2; show_menu ;;
        2) 
            [ ! -f "$CONFIG" ] && echo "è¯·å…ˆé€‰æ‹© 1 å¯åŠ¨èŠ‚ç‚¹" && sleep 2 && show_menu
            PORT=$(grep 'listen_port' $CONFIG | tr -cd '0-9')
            UUID=$(grep 'uuid' $CONFIG | awk -F'"' '{print $4}')
            IP=$(curl -s ipv4.icanhazip.com)
            PATH_WS=$(grep 'path' $CONFIG | awk -F'"' '{print $4}')
            echo -e "\n${YELLOW}ä½ çš„ VLESS åˆ†äº«é“¾æ¥:${NC}"
            echo -e "${GREEN}vless://$UUID@$IP:$PORT?encryption=none&security=none&type=ws&path=$PATH_WS#Serv00_tujiaojie${NC}"
            echo ""
            read -p "æŒ‰å›è½¦é”®è¿”å›èœå•..." ; show_menu ;;
        3) pkill -9 sing-box; echo -e "${RED}æœåŠ¡å·²åœæ­¢ã€‚${NC}"; sleep 1; show_menu ;;
        4) pkill -9 sing-box; rm -rf $WORKDIR; echo -e "${RED}å·²å½»åº•å¸è½½ã€‚${NC}"; exit 0 ;;
        0) exit 0 ;;
        *) show_menu ;;
    esac
}

show_menu
